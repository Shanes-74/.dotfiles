#!/bin/bash

# Configurações
APP_COMMAND="spotify-launcher"
# Procuramos pelo processo real do spotify, não o script
REAL_PROCESS="spotify"
HIDDEN_WS="special:magic_spotify"

# 1. Verifica se o Spotify está rodando
PID=$(pgrep -x "$REAL_PROCESS")

if [ -z "$PID" ]; then
    # Se não está rodando, abre e encerra
    echo "Iniciando Spotify..."
    $APP_COMMAND &
    exit 0
fi

# 2. Se está rodando, localiza a janela (usando hyprctl)
# Pegamos o endereço da janela e o workspace atual dela
WINDOW_DATA=$(hyprctl clients -j | jq -r ".[] | select(.class == \"Spotify\" or .initialClass == \"spotify\")")
ADDR=$(echo "$WINDOW_DATA" | jq -r '.address')
SPOTIFY_WS=$(echo "$WINDOW_DATA" | jq -r '.workspace.name')

# Se não encontrou a janela ainda (pode estar carregando)
if [ -z "$ADDR" ] || [ "$ADDR" == "null" ]; then
    echo "Processo encontrado, mas janela não detectada. Tente novamente em 1s."
    exit 1
fi

# 3. Descobre o workspace atual do monitor focado
CURRENT_WS=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true) | .activeWorkspace.id')

# 4. Lógica de troca
if [ "$SPOTIFY_WS" == "$HIDDEN_WS" ]; then
    # Está escondido, traz para cá
    hyprctl dispatch movetoworkspacesilent "$CURRENT_WS,address:$ADDR"
    hyprctl dispatch focuswindow "address:$ADDR"
else
    # Está visível, manda para o especial
    hyprctl dispatch movetoworkspacesilent "$HIDDEN_WS,address:$ADDR"
fi