#!/usr/bin/env python3
import os
import sys
import subprocess
import random
import glob
from pathlib import Path

# --- CONFIGURAÇÕES ---
# Usando Path.home() para evitar hardcoding de usuário se possível
HOME = str(Path.home())
WALLPAPER_DIR = os.path.join(HOME, "Imagens/Wallpapers")
CONFIG_MATUGEN = os.path.join(HOME, ".config/matugen/config.toml")

# --- RECONSTRUÇÃO DO AMBIENTE ---
uid = os.getuid()
os.environ["PATH"] = f"{HOME}/.local/bin:/usr/local/bin:/usr/bin:/bin:{os.environ.get('PATH', '')}"
os.environ["XDG_RUNTIME_DIR"] = f"/run/user/{uid}"

def fix_wayland_env():
    if not os.environ.get("WAYLAND_DISPLAY"):
        try:
            sockets = glob.glob(f"{os.environ['XDG_RUNTIME_DIR']}/wayland-*")
            if sockets:
                os.environ["WAYLAND_DISPLAY"] = os.path.basename(sockets[0])
        except Exception:
            os.environ["WAYLAND_DISPLAY"] = "wayland-0"

fix_wayland_env()

def apply_hooks():
    # Hooks organizados para evitar travamentos
    hooks = [
        "killall -q waybar; (waybar > /dev/null 2>&1 &)",
        "hyprctl reload",
        "pkill -USR1 kitty",
        "killall -q swaync",
        "killall -q swayosd-server",
        "killall -q xdg-desktop-portal-gtk",
        "killall -q gnome-clocks"
    ]
    for cmd in hooks:
        try:
            subprocess.run(cmd, shell=True, capture_output=True)
        except Exception as e:
            print(f"Erro no hook {cmd}: {e}")

def main():
    # 1. Definição do Wallpaper
    if len(sys.argv) > 1 and not sys.argv[1].startswith("-"):
        wallpaper = sys.argv[1]
    else:
        files = glob.glob(f"{WALLPAPER_DIR}/**/*.*", recursive=True)
        valid_files = [f for f in files if f.lower().endswith(('.png', '.jpg', '.jpeg', '.webp'))]
        if not valid_files:
            print("Nenhum wallpaper encontrado.")
            sys.exit(1)
        wallpaper = random.choice(valid_files)

    if not os.path.exists(wallpaper):
        sys.exit(1)

    # 2. Rofi: Seleção de Esquema
    schemes = {
        "Conteúdo": "content", "Expressivo": "expressive", "Fidelidade": "fidelity",
        "Salada de Frutas": "fruit-salad", "Monocromático": "monochrome",
        "Neutro": "neutral", "Arco-Íris": "rainbow", "Ponto Tonal": "tonal-spot", "Vibrante": "vibrant"
    }
    
    input_schemes = "\n".join(schemes.keys())
    rofi_scheme = subprocess.Popen(["rofi", "-dmenu", "-i", "-p", "Esquema de Cores", "-l", "9"], 
                                   stdin=subprocess.PIPE, stdout=subprocess.PIPE, text=True)
    selected_display, _ = rofi_scheme.communicate(input=input_schemes)
    selected_display = selected_display.strip()
    
    if not selected_display or selected_display not in schemes:
        sys.exit(0)
    
    selected_clean = schemes[selected_display]

    # 3. Rofi: Modo
    modes = {"Escuro": "dark", "Claro": "light"}
    input_modes = "\n".join(modes.keys())
    rofi_mode = subprocess.Popen(["rofi", "-dmenu", "-i", "-p", "Modo", "-l", "2"], 
                                 stdin=subprocess.PIPE, stdout=subprocess.PIPE, text=True)
    selected_m_display, _ = rofi_mode.communicate(input=input_modes)
    selected_m_display = selected_m_display.strip()

    if not selected_m_display or selected_m_display not in modes:
        sys.exit(0)
    
    mode_val = modes[selected_m_display]

    # 4. SWWW
    try:
        # Verifica se o daemon está rodando
        subprocess.run(["swww-daemon", "--format", "xrgb"], check=False, capture_output=True)
        
        trans = random.choice(["outer", "center", "wipe", "wave", "grow"])
        subprocess.run([
            "swww", "img", wallpaper, 
            "--transition-type", trans, 
            "--transition-duration", "2.0", 
            "--transition-fps", "144"
        ])
    except Exception as e:
        print(f"Erro SWWW: {e}")

    # 5. Matugen
    try:
        # Comando estruturado como lista é mais seguro contra caminhos com espaços
        matugen_cmd = [
            "matugen", "-c", CONFIG_MATUGEN, "image", wallpaper, 
            "-m", mode_val, "-t", f"scheme-{selected_clean}"
        ]
        subprocess.run(matugen_cmd, check=True)
    except Exception as e:
        print(f"Erro Matugen: {e}")

    # 6. Execução dos Hooks
    apply_hooks()

if __name__ == "__main__":
    main()