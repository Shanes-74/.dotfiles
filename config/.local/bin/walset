#!/usr/bin/env bash

set -o pipefail

WALLPAPER_DIR="$HOME/Imagens/Wallpapers"
NOTIFY_ID_FILE="/tmp/walset-notify-id"

notify_start() {
  notify-send -p -t 0 "Walset" "Aplicando tema…" > "$NOTIFY_ID_FILE"
}

notify_update() {
  notify-send -r "$(cat "$NOTIFY_ID_FILE")" -t 0 "Walset" "$1"
}

notify_success() {
  notify-send -r "$(cat "$NOTIFY_ID_FILE")" -t 2000 "Walset" "✅ Tema aplicado com sucesso"
}

notify_error() {
  notify-send -r "$(cat "$NOTIFY_ID_FILE" 2>/dev/null)" \
    -u critical -t 0 "Walset" "❌ Tema NÃO foi aplicado"
  exit 1
}

# ───────── Escolha do wallpaper ─────────

if [ -n "$1" ]; then
  WALLPAPER="$1"
  [ -f "$WALLPAPER" ] || notify_error
else
  [ -d "$WALLPAPER_DIR" ] || notify_error

  WALLPAPER=$(find "$WALLPAPER_DIR" -type f \( \
    -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \
  \) | shuf -n 1)

  [ -n "$WALLPAPER" ] || notify_error
fi

# ───────── Início ─────────

notify_start

# ───────── swww ─────────

if ! pgrep -x swww-daemon > /dev/null; then
  swww init || notify_error
fi

swww img "$WALLPAPER" \
  --transition-type center \
  --transition-duration 2.0 \
  --transition-fps 144 \
|| notify_error

# ───────── matugen ─────────

matugen image "$WALLPAPER" || notify_error

# ───────── Final ─────────

notify_success
rm -f "$NOTIFY_ID_FILE"
