#!/usr/bin/env bash
set -euo pipefail

# =====================================================
# WALSET — Clean Theme Manager
# =====================================================

HOME_DIR="$HOME"
CACHE_DIR="$HOME_DIR/.cache/walset"
STATE_FILE="$CACHE_DIR/state.json"

WALLPAPER_DIR="$HOME_DIR/Imagens/Wallpapers"
CONFIG_MATUGEN="$HOME_DIR/.config/matugen/config.toml"
ROFI_THEME="$HOME_DIR/.config/rofi/rofi.rasi"

SDDM_ASSETS_DIR="$HOME_DIR/.dotfiles/sddm/sddm-current/assets"
SDDM_BG="$SDDM_ASSETS_DIR/background.jpg"

mkdir -p "$CACHE_DIR"

export PATH="$HOME_DIR/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
export XDG_RUNTIME_DIR="/run/user/$(id -u)"


# ---------- DEP CHECK ----------

for cmd in swww matugen rofi jq; do
    command -v "$cmd" >/dev/null 2>&1 || {
        echo "❌ Dependência faltando: $cmd"
        exit 1
    }
done


# ---------- FUNCTIONS ----------

save_state() {
    jq -n \
        --arg wallpaper "$1" \
        --arg scheme "$2" \
        --arg mode "$3" \
        '{wallpaper: $wallpaper, scheme: $scheme, mode: $mode}' \
        > "$STATE_FILE"
}

load_state() {
    if [[ -f "$STATE_FILE" ]]; then
        SCHEME=$(jq -r '.scheme // "content"' "$STATE_FILE")
        MODE=$(jq -r '.mode // "dark"' "$STATE_FILE")
    else
        SCHEME="content"
        MODE="dark"
    fi
}

apply_hooks() {

    # Recarrega Hyprland
    hyprctl reload >/dev/null 2>&1 || true

    # Recarrega kitty (tema)
    pkill -USR1 kitty >/dev/null 2>&1 || true

    # Reinicia notificações
    swaync-client -rs >/dev/null 2>&1 || true

    # Mata serviços que precisam reiniciar
    killall -q swayosd-server >/dev/null 2>&1 || true
    killall -q xdg-desktop-portal-gtk >/dev/null 2>&1 || true
    killall -q gnome-clocks >/dev/null 2>&1 || true

    # Reinicia Waybar
    pkill waybar >/dev/null 2>&1 || true
    waybar >/dev/null 2>&1 &

}

update_sddm() {
    mkdir -p "$SDDM_ASSETS_DIR"
    cp "$WALLPAPER" "$SDDM_BG"
    command -v sddm-sync >/dev/null 2>&1 && sddm-sync || true
}


# ---------- MAIN ----------

load_state

# Wallpaper
if [[ -n "${1:-}" ]]; then
    WALLPAPER="$1"
else
    mapfile -t FILES < <(
        find "$WALLPAPER_DIR" -type f \
        \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.jpeg" -o -iname "*.webp" \)
    )

    [[ ${#FILES[@]} -eq 0 ]] && { echo "❌ Nenhum wallpaper encontrado"; exit 1; }

    WALLPAPER="${FILES[RANDOM % ${#FILES[@]}]}"
fi


# Scheme
if [[ -n "${2:-}" ]]; then
    SELECTED="$2"
else
    CHOICE=$(printf "%s\n" \
        "Conteúdo" "Expressivo" "Fidelidade" "Salada de Frutas" \
        "Monocromático" "Neutro" "Arco-Íris" "Ponto Tonal" "Vibrante" \
        | rofi -dmenu -i -p "Esquema de Cores" -theme "$ROFI_THEME")

    declare -A MAP=(
        ["Conteúdo"]="content"
        ["Expressivo"]="expressive"
        ["Fidelidade"]="fidelity"
        ["Salada de Frutas"]="fruit-salad"
        ["Monocromático"]="monochrome"
        ["Neutro"]="neutral"
        ["Arco-Íris"]="rainbow"
        ["Ponto Tonal"]="tonal-spot"
        ["Vibrante"]="vibrant"
    )

    SELECTED="${MAP[$CHOICE]:-$SCHEME}"
fi


# Mode
MODE="${3:-$MODE}"


# swww
TRANS=(outer center wipe wave grow)
T="${TRANS[RANDOM % ${#TRANS[@]}]}"

swww img "$WALLPAPER" \
    --transition-type "$T" \
    --transition-duration 1.7 \
    --transition-fps 90


# matugen
matugen \
    -c "$CONFIG_MATUGEN" \
    image "$WALLPAPER" \
    -m "$MODE" \
    -t "scheme-$SELECTED"


save_state "$WALLPAPER" "$SELECTED" "$MODE"

apply_hooks

update_sddm
