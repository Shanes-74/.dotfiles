#!/usr/bin/env bash

# =====================================================
# WALSET — Clean Theme Manager
# =====================================================


# ---------------- CONFIG ----------------

HOME_DIR="$HOME"

CACHE_DIR="$HOME_DIR/.cache/walset"
STATE_FILE="$CACHE_DIR/state.json"

WALLPAPER_DIR="$HOME_DIR/Imagens/Wallpapers"
CONFIG_MATUGEN="$HOME_DIR/.config/matugen/config.toml"

ROFI_THEME="$HOME_DIR/.config/rofi/rofi.rasi"

# SDDM
SDDM_ASSETS_DIR="$HOME_DIR/.dotfiles/sddm/sddm-current/assets"
SDDM_BG="$SDDM_ASSETS_DIR/background.jpg"


# ---------------- ENV ----------------

mkdir -p "$CACHE_DIR"

export PATH="$HOME_DIR/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH"
export XDG_RUNTIME_DIR="/run/user/$(id -u)"


# ---------------- CORE ----------------

run_step() {

    local name="$1"
    shift

    if "$@"; then
        return 0
    else
        echo "❌ Erro em: $name" >&2
        exit 1
    fi
}


save_state() {

cat > "$STATE_FILE" <<EOF
{
  "wallpaper": "$1",
  "scheme": "$2",
  "mode": "$3"
}
EOF

}


load_state() {

SCHEME="content"
MODE="dark"

if [[ -f "$STATE_FILE" ]]; then

    SCHEME=$(grep '"scheme"' "$STATE_FILE" | cut -d'"' -f4)
    MODE=$(grep '"mode"' "$STATE_FILE" | cut -d'"' -f4)

fi

}


apply_hooks() {

hyprctl reload >/dev/null 2>&1

pkill -USR1 kitty >/dev/null 2>&1

swaync-client -rs >/dev/null 2>&1

killall -q swayosd-server >/dev/null 2>&1
killall -q xdg-desktop-portal-gtk >/dev/null 2>&1
killall -q gnome-clocks >/dev/null 2>&1

pkill waybar >/dev/null 2>&1
waybar >/dev/null 2>&1 &

}


update_sddm() {

    mkdir -p "$SDDM_ASSETS_DIR"

    cp "$WALLPAPER" "$SDDM_BG"

    # Recarrega o tema do SDDM sem reiniciar sessão
    if command -v sddm-sync >/dev/null 2>&1; then
        sddm-sync
    fi

}


# ---------------- MAIN ----------------


# ---------- LOAD STATE ----------

load_state


# ---------- WALLPAPER ----------

if [[ -n "${1:-}" ]]; then

    WALLPAPER="$1"

else

    mapfile -t FILES < <(
        find "$WALLPAPER_DIR" -type f \
        \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.jpeg" -o -iname "*.webp" \)
    )

    if [[ ${#FILES[@]} -eq 0 ]]; then
        echo "❌ Nenhum wallpaper encontrado" >&2
        exit 1
    fi

    WALLPAPER="${FILES[RANDOM % ${#FILES[@]}]}"

fi


# ---------- SCHEME ----------

if [[ -n "${2:-}" ]]; then

    SELECTED="$2"

else

CHOICE=$(
cat <<EOF | rofi -dmenu -i -p "Esquema de Cores" -l 9 -theme "$ROFI_THEME"
Conteúdo
Expressivo
Fidelidade
Salada de Frutas
Monocromático
Neutro
Arco-Íris
Ponto Tonal
Vibrante
EOF
)

case "$CHOICE" in
    "Conteúdo") SELECTED="content" ;;
    "Expressivo") SELECTED="expressive" ;;
    "Fidelidade") SELECTED="fidelity" ;;
    "Salada de Frutas") SELECTED="fruit-salad" ;;
    "Monocromático") SELECTED="monochrome" ;;
    "Neutro") SELECTED="neutral" ;;
    "Arco-Íris") SELECTED="rainbow" ;;
    "Ponto Tonal") SELECTED="tonal-spot" ;;
    "Vibrante") SELECTED="vibrant" ;;
    *) SELECTED="$SCHEME" ;;
esac

fi


# ---------- MODE ----------

if [[ -n "${3:-}" ]]; then
    MODE="$3"
fi


# ---------- SWWW ----------

TRANS=(outer center wipe wave grow)

T="${TRANS[RANDOM % 5]}"

run_step "Wallpaper (swww)" \
    swww img "$WALLPAPER" \
    --transition-type "$T" \
    --transition-duration 1.7 \
    --transition-fps 90


# ---------- MATUGEN ----------

run_step "Geração de cores (matugen)" \
    matugen \
    -c "$CONFIG_MATUGEN" \
    image "$WALLPAPER" \
    -m "$MODE" \
    -t "scheme-$SELECTED"


# ---------- SAVE + HOOKS ----------

save_state "$WALLPAPER" "$SELECTED" "$MODE"

apply_hooks


# ---------- SDDM ----------

run_step "Atualização do SDDM" update_sddm


# ---------- FINAL ----------

echo "✅ Tema aplicado com sucesso."