#!/usr/bin/env python3
import os
import sys
import subprocess
import random
import glob
import json
from pathlib import Path

# --- CONFIGURAÇÕES ---
HOME = str(Path.home())
CACHE_DIR = os.path.join(HOME, ".cache", "walset")
STATE_FILE = os.path.join(CACHE_DIR, "state.json")
WALLPAPER_DIR = os.path.join(HOME, "Imagens/Wallpapers")
CONFIG_MATUGEN = os.path.join(HOME, ".config/matugen/config.toml")

os.makedirs(CACHE_DIR, exist_ok=True)

# --- RECONSTRUÇÃO DO AMBIENTE ---
uid = os.getuid()
os.environ["PATH"] = f"{HOME}/.local/bin:/usr/local/bin:/usr/bin:/bin:{os.environ.get('PATH', '')}"
os.environ["XDG_RUNTIME_DIR"] = f"/run/user/{uid}"

def save_state(wallpaper, scheme, mode):
    state = {"wallpaper": wallpaper, "scheme": scheme, "mode": mode}
    with open(STATE_FILE, "w") as f:
        json.dump(state, f, indent=4)

def load_state():
    if os.path.exists(STATE_FILE):
        try:
            with open(STATE_FILE, "r") as f:
                return json.load(f)
        except: return {}
    return {}

def apply_hooks():
    hooks = [
        "hyprctl reload",
        "pkill -USR1 kitty",
        "swaync-client -R -rs",
        "killall -q swayosd-server",
        "killall -q xdg-desktop-portal-gtk",
        "killall -q gnome-clocks",
        "pkill -USR2 waybar"
    ]
    for cmd in hooks:
        subprocess.run(cmd, shell=True, capture_output=True)

def main():
    state = load_state()
    
    # 1. Wallpaper
    if len(sys.argv) > 1:
        wallpaper = sys.argv[1]
    else:
        files = glob.glob(f"{WALLPAPER_DIR}/**/*.*", recursive=True)
        valid_files = [f for f in files if f.lower().endswith(('.png', '.jpg', '.jpeg', '.webp'))]
        if not valid_files:
            sys.exit(1)
        wallpaper = random.choice(valid_files)

    # 2. Esquema de Cores
    if len(sys.argv) > 2:
        selected_clean = sys.argv[2]
    else:
        schemes = {
            "Conteúdo": "content", "Expressivo": "expressive", "Fidelidade": "fidelity",
            "Salada de Frutas": "fruit-salad", "Monocromático": "monochrome",
            "Neutro": "neutral", "Arco-Íris": "rainbow", "Ponto Tonal": "tonal-spot", "Vibrante": "vibrant"
        }
        input_s = "\n".join(schemes.keys())
        rofi = subprocess.Popen(["rofi", "-dmenu", "-i", "-p", "Esquema de Cores", "-l", "9"], 
                                stdin=subprocess.PIPE, stdout=subprocess.PIPE, text=True)
        res, _ = rofi.communicate(input=input_s)
        res = res.strip()
        selected_clean = schemes.get(res, state.get("scheme", "content"))

    # 3. Modo
    if len(sys.argv) > 3:
        mode_val = sys.argv[3]
    else:
        mode_val = state.get("mode", "dark") 

    # 4. SWWW - Execução Direta
    try:
        # Escolhe a animação aleatória
        trans = random.choice(["outer", "center", "wipe", "wave", "grow"])
        
        # Executa o comando diretamente presumindo que o daemon já está ativo
        subprocess.run([
            "swww", "img", wallpaper, 
            "--transition-type", trans, 
            "--transition-duration", "1.7", 
            "--transition-fps", "90"
        ])
    except Exception as e:
        print(f"Erro ao aplicar wallpaper com swww: {e}")

    # 5. Matugen
    try:
        matugen_cmd = [
            "matugen", "-c", CONFIG_MATUGEN, "image", wallpaper, 
            "-m", mode_val, "-t", f"scheme-{selected_clean}"
        ]
        subprocess.run(matugen_cmd, check=True)
    except Exception as e:
        print(f"Erro Matugen: {e}")

    # 6. Salva Estado e Hooks
    save_state(wallpaper, selected_clean, mode_val)
    apply_hooks()

if __name__ == "__main__":
    main()